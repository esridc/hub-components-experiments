import{r as t,h as e,H as o}from"./p-d703c309.js";import{b as n,g as s,a as r}from"./p-6343e8b1.js";import{g as c}from"./p-7c13aa15.js";import{c as i}from"./p-b090f4cf.js";import{g as a}from"./p-797f9b51.js";import{c as u}from"./p-90bbd14a.js";import{a as l,c as h}from"./p-937fb610.js";import{c as p,g as b,a as m,b as d}from"./p-6bdf64e1.js";import{s as f}from"./p-46d9ff3a.js";import{a as g}from"./p-0050330c.js";import{U as w}from"./p-82285f77.js";import"./p-ae8fd155.js";import"./p-a8ccf5d0.js";const y=p.apiTypes.map((t=>t.toLowerCase()));function O(t){return Object.keys(t).reduce(((e,o)=>(e[o]=Object.keys(t[o]).reduce(((e,n)=>(e.push({key:n,docCount:t[o][n]}),e)),[]).sort(j),e)),{})}function j(t,e){return e.docCount>t.docCount?1:-1}const $=["tags","type","access","categories"],k={collection:"type"},A=["title","created","type","owner","modified","avgrating","numratings","numcomments","numviews"],P={name:"title"};function N(t){return{any:" OR ",all:" AND ",not:" NOT ",between:" TO "}[t||"any"]}const v={downloadable:function(t){let e,o;return"true"===(a(t,"downloadable.terms")||[])[0]?(e=p.downloadableTypes.map((t=>`type:"${t}"`)),o=p.downloadableTypeKeywords.map((t=>`typekeywords:"${t}"`))):(e=p.downloadableTypes.map((t=>`-type:"${t}"`)),o=p.downloadableTypeKeywords.map((t=>`-typekeywords:"${t}"`))),`(${e.concat(o).join(" OR ")})`},hasApi:function(t){let e;return e=(a(t,"hasApi.terms")||[])[0]?p.apiTypes.map((t=>`type:"${t}"`)).join(" OR "):p.apiTypes.map((t=>`-type:"${t}"`)).join(" OR "),`(${e})`},groupIds:function(t){return`(${(a(t,"groupIds.terms")||[]).map((t=>`group:"${t}"`)).join(" OR ")})`},collection:function(t){return`(${(a(t,"collection.terms")||[]).map((t=>m(t))).filter((t=>!!t)).reduce(((t,e)=>(e.forEach((e=>{t.push(`type:"${e}"`)})),t)),[]).join(" OR ")})`}};function x(t){const e=[],o=[];if(Object.keys(t).forEach((n=>{let s;s=v[n]?v[n](t,n):function(t,e){const o=a(t,`${e}.terms`)||[],n=a(t,`${e}.fn`);let s;if("between"===n){const t=o[0];let r=o[1];t===r&&(r=l(t,1));const c=[t,r].map((t=>new Date(t).getTime()));s=`${e.toLowerCase()}: [${c.join(N(n))}]`}else s=o.map((t=>`${e.toLowerCase()}:"${t}"`)).join(N(n));return"not"===n&&(s=`NOT ${s}`),`(${s})`}(t,n),t[n].catalogDefinition?e.push(s):o.push(s)})),e.length){const t=`(${e.join(" OR ")})`;return o.length?`${t} AND (${o.join(" AND ")})`:t}return o.length?o.join(" AND "):""}async function D(t,e,o,n){const s=function(t={}){const e={q:null,start:a(t,"page.start")||1,num:a(t,"page.size")||10};let o=['-type:"code attachment"'];if(t.restricted&&o.push("-access:public"),t.q&&o.push(t.q),t.catalog){const e=u(t.catalog);o.push(x(e))}const n=u(t),s=u(t.filter),r=Object.assign(Object.assign({},n),s);if(Object.keys(r).length&&o.push(x(r)),o=o.filter((t=>!!t)),e.q=o.join(" AND "),t.bbox&&(e.bbox=t.bbox),t.sort){const o="-"===t.sort[0]?"desc":"asc";let n="desc"===o?t.sort.substring(1).split(",")[0]:t.sort.split(",")[0];n=A.indexOf(c=n)>=0?c:c in P?P[c]:void 0,n&&(e.sortField=n,e.sortOrder=o)}var c;if(t.agg&&t.agg.fields){let o;o=Array.isArray(t.agg.fields)?t.agg.fields.join(","):t.agg.fields;const{countFields:n,countSize:s}=function(t){const e=t.split(",").filter((t=>$.indexOf(t)>-1)),o=t.split(",").filter((t=>Object.keys(k).indexOf(t)>-1));return Object.keys(k).forEach((t=>{o.indexOf(t)>-1&&!(k[t]in e)&&e.push(k[t])})),{countFields:e.join(","),countSize:200}}(o);e.countFields=n,e.countSize=s}return e}(t);if(s.countFields){const t=h(s.countFields.split(","),3).map((t=>t.join(","))).map((t=>f(Object.assign(Object.assign({},s),{params:{token:e,countFields:t,countSize:s.countSize},portal:o,authentication:n,httpMethod:"POST"})))),r=await Promise.all(t);let c=[];for(const t of r){const e=a(t,"aggregations.counts")||[];c=c.concat(e)}return r[0].aggregations={counts:c},r[0]}return f(Object.assign(Object.assign({},s),{params:{token:e,countFields:s.countFields,countSize:s.countSize},portal:o,httpMethod:"POST",authentication:n}))}const S=["downloadable"],E=["hasApi","collection"],R={downloadable:function(t){return t.results.reduce(((t,e)=>((e.typeKeywords||[]).indexOf("Data")>-1||p.downloadableTypes.indexOf(e.type)>-1?t.downloadable.true++:t.downloadable.false++,t)),{downloadable:{true:0,false:0}})},hasApi:function(t={}){const e=(a(t,"counts")||[]).filter((t=>"type"===t.fieldName))[0];return e?e.fieldValues.reduce(((t,e)=>(y.indexOf(e.value)>-1?t.hasApi.true+=e.count:t.hasApi.false+=e.count,t)),{hasApi:{true:0,false:0}}):{hasApi:{}}},collection:function(t={}){const e=(a(t,"counts")||[]).filter((t=>"type"===t.fieldName))[0];return e?e.fieldValues.reduce(((t,e)=>{const o=b(e.value);let n;return n=o?o.toLowerCase().split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" "):"Other",t.collection[n]=e.count,t}),{collection:{}}):{collection:{}}}};function C(t,e){return t.filter((t=>-1!==e.indexOf(t)))}function T(t,e,o){if(t)try{const n=t.match(new RegExp(e,"ig"));if(!n)return;return n.reduce(function(t){return(e,o)=>{const n=`<mark class="hub-search-highlight ${t}-highlight">${o}</mark>`;return e.replace(new RegExp(o,"g"),n)}}(o),t)}catch(t){return}}function z(t){const e=b(t.type),o={name:t.title,searchDescription:t.description,hubType:e||"Other",collection:d(t),extent:(n=t.extent,{coordinates:n,type:"envelope"})};var n;return Object.assign(Object.assign({},t),o)}async function q(t,e,o,n){const s=await D(t,e,o,n);return function(t,e={},o){const n=Object.assign({},o);return{data:t.results.map((t=>function(t,e){const o={id:t.id,type:"item",attributes:z(t)};return e&&(o.meta={},o.meta.highlights=function(t,e){return{name:T(t.title,e,"name"),searchDescription:T(t.description,e,"description")}}(t,e)),o}(t,n.q))),meta:{query:t.query,queryParameters:n,stats:{aggs:e,count:t.results.length,totalCount:t.total},page:{start:t.start,size:t.num,nextStart:t.nextStart}}}}(s,await async function(t={counts:Array()},e,o,n,s){const r=a(e,"agg.fields"),c=r?r.split(","):[];let i=C(c,S),u={};if(i.length>0){const t=Object.assign(Object.assign({},e),{start:1,num:100});t.agg={};const r=await D(t,o,n,s);i.forEach((t=>{const e=R[t](r);u=Object.assign(Object.assign({},u),O(e))}))}const l=t.counts.reduce(((t,e)=>(t[e.fieldName]=e.fieldValues.map((t=>({key:t.value,docCount:t.count}))),t)),{});i=C(c,E);let h={};i.length>0&&i.forEach((e=>{const o=Object.assign({},R[e](t));h=Object.assign(Object.assign({},h),O(o))}));const p=Object.assign(Object.assign(Object.assign({},u),l),h);return p.categories&&(p.categories=function(t=[]){const e=new Set,o=["","categories"];return t.forEach((t=>{t.key.split("/").filter((t=>-1===o.indexOf(t))).forEach((t=>{e.add(t)}))})),Array.from(e).reduce(((e,o)=>{const n=t.filter((t=>t.key.includes(o))).map((t=>t.docCount)).reduce(((t,e)=>t+e));return e.push({key:o,docCount:n}),e}),[])}(p.categories)),p}(s.aggregations,t,e,o),t)}let F={create(t){switch(t){case"portal":return new G;case"hub":return new I}}};class G{constructor(){this.portalUrl="https://www.arcgis.com/share/rest/"}canEdit(t,e){return Promise.all([n(t),c(e)]).then((([t,e])=>t.member.filter((t=>e.groups.includes(t))).length>0))}search(t){return q({q:t})}create(t,e){return i({item:t,authentication:e})}get(t){return Promise.all([s(t),r(t)]).then((([t,e])=>(t.data=e,t)))}update(t,e){return new Promise(((t,e)=>e(!1)))}delete(t){return new Promise(((t,e)=>e(!1)))}}class I{constructor(){this.hubUrl="https://hub.arcgis.com/api/v3"}canEdit(t,e){return fetch(`${this.hubUrl}/content/${t}`,{method:"GET"}).then((t=>200==t.status))}async search(t){return(await fetch(`${this.hubUrl}/search`,{method:"GET",body:JSON.stringify(t)})).json()}create(t,e){return delete t.id,delete t.owner,delete t.orgId,i({item:t,authentication:e})}get(t){return Promise.all([s(t),r(t)]).then((([t,e])=>(t.data=e,t)))}update(t,e){return new Promise(((t,e)=>e(!1)))}delete(t){return new Promise(((t,e)=>e(!1)))}}let L=class{constructor(e){t(this,e),this.item="",this.allowScripts=!0,this.view="preview",this.clientid="",this.portal="https://www.arcgis.com",this.sandboxSettings=["allow-same-origin"]}componentWillLoad(){this.allowScripts&&this.sandboxSettings.push("allow-scripts")}componentDidLoad(){"edit"==this.view?this.getEdit():this.getPreview(),F.create("hub").get(this.item).then((t=>{console.log("Notebook",t),this.notebook=t,this.titleEl.innerText=t.title}))}getEdit(){const t=`${this.portal}/home/notebook/notebook.html?id=${this.item}`;console.debug("ArcGIS Notebook getEdit",t),this.iFrameEl.src=t}getPreview(){const t=`${this.portal}/sharing/rest/content/items/${this.item}/resources/notebook_preview.json`;console.log("Notebook getPreview",t),fetch(t).then((t=>{t.json().then((t=>{const e=t.html.indexOf("<body>")+6;t.html=t.html.slice(0,e)+"<style>#notebook-container { box-shadow: none; -webkit-box-shadow: none; padding: 0; }</style>"+t.html.slice(e);const o=this.iFrameEl.contentWindow.document;o.open(),o.write(t.html),o.close()}))})).catch((t=>{console.error("Error in arcgis-notebook getPreview",t)}))}onCopy(t){return g(this.clientid,this.portal).then((t=>(this.session=t,this.copyNotebook())))}copyNotebook(){console.log("onCopy starting",this.notebook),F.create("hub").create(this.notebook,w.deserialize(this.session)).then((t=>{console.log("onCopy Done",t)}))}render(){return e(o,null,e("h3",{id:"notebook-title",ref:t=>this.titleEl=t}),e("span",{class:"notebook-title"},e("slot",{name:"title"})),e("hub-button",{class:"notebook-copy-button",color:"dark",text:"Copy Notebook",action:this.onCopy}),e("iframe",{sandbox:this.sandboxSettings.join(" "),src:"",id:"notebook-iframe",ref:t=>this.iFrameEl=t}))}};L.style=":host{display:block;width:100%;height:100%}iframe{border:none;width:100%;height:100%}.notebook-copy-button{float:right;margin:10px 33px 0 0}.notebook-title{margin-left:33px;float:left}";export{L as arcgis_notebook}